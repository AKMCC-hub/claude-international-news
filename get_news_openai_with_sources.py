#!/usr/bin/env python3
"""
ä½¿ç”¨ OpenAI æ ¼å¼ + Function Calling è·å–æ–°é—»ï¼ˆå¸¦æ¥æºï¼‰
è™½ç„¶ OpenAI æ ¼å¼ä¸æ”¯æŒè‡ªåŠ¨ web_searchï¼Œä½†å¯ä»¥é€šè¿‡ä¸¤ç§æ–¹å¼è·å–æ¥æºä¿¡æ¯ï¼š
1. ä½¿ç”¨ Anthropic Messages APIï¼ˆè‡ªåŠ¨æœç´¢ï¼‰
2. æ‰‹åŠ¨å®ç° function calling æµç¨‹
3. é€šè¿‡ç²¾å¿ƒè®¾è®¡çš„ prompt è®© AI æ ‡æ³¨æ¥æº
"""

import requests
import json
from datetime import datetime

# å¯¼å…¥é…ç½®æ¨¡å—
try:
    from config import API_KEY, API_BASE_URL, DEFAULT_MODEL
except ImportError:
    # å¦‚æœé…ç½®æ¨¡å—ä¸å­˜åœ¨ï¼Œä»ç¯å¢ƒå˜é‡è·å–
    import os
    API_KEY = os.environ.get('API_KEY')
    if not API_KEY:
        raise ValueError("API_KEY not found. Please set it in environment variable or .env file")
    API_BASE_URL = os.environ.get('API_BASE_URL', "https://spai.aicoding.sh")
    DEFAULT_MODEL = os.environ.get('DEFAULT_MODEL', "claude-sonnet-4-5-20250929")

def get_news_openai_format_with_source_prompt():
    """
    æ–¹æ³•1ï¼šOpenAI æ ¼å¼ + ä¼˜åŒ–çš„æç¤ºè¯
    è®© AI æ˜ç¡®æ ‡æ³¨ä¿¡æ¯æ¥æºï¼ˆåŸºäºçŸ¥è¯†åº“ï¼‰
    """

    url = f"{API_BASE_URL}/v1/chat/completions"

    headers = {
        "Content-Type": "application/json",
        "Authorization": f"Bearer {API_KEY}"
    }

    data = {
        "model": "claude-3-5-haiku-20241022",
        "messages": [
            {
                "role": "system",
                "content": """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æ–°é—»åŠ©æ‰‹ã€‚åœ¨æä¾›æ–°é—»æ—¶ï¼Œå¿…é¡»éµå¾ªä»¥ä¸‹æ ¼å¼ï¼š

å¯¹äºæ¯æ¡æ–°é—»ï¼Œå¿…é¡»åŒ…å«ï¼š
1. **æ ‡é¢˜**ï¼šç®€æ´æ˜ç¡®çš„æ–°é—»æ ‡é¢˜
2. **å†…å®¹**ï¼š2-3å¥è¯çš„æ–°é—»æ‘˜è¦
3. **æ¥æºè¯´æ˜**ï¼š
   - å¦‚æœæ˜¯åŸºäºä½ çš„çŸ¥è¯†åº“ï¼ˆæˆªæ­¢åˆ°2024å¹´4æœˆï¼‰ï¼šæ˜ç¡®è¯´æ˜"åŸºäºçŸ¥è¯†åº“"
   - è¯´æ˜è¿™æ˜¯å“ªä¸ªåœ°åŒº/å›½å®¶çš„äº‹ä»¶
   - å¦‚æœçŸ¥é“å…·ä½“çš„æ–°é—»æœºæ„ï¼Œå¯ä»¥æåŠï¼ˆå¦‚è·¯é€ç¤¾ã€BBCç­‰ï¼‰

é‡è¦ï¼šå¿…é¡»æ˜ç¡®åŒºåˆ†"å®æ—¶æ–°é—»"å’Œ"çŸ¥è¯†åº“ä¿¡æ¯"ã€‚"""
            },
            {
                "role": "user",
                "content": "è¯·æä¾›5æ¡é‡è¦çš„å›½é™…æ–°é—»ã€‚æ¯æ¡æ–°é—»å¿…é¡»æ˜ç¡®æ ‡æ³¨ä¿¡æ¯æ¥æºå’Œæ—¶æ•ˆæ€§ã€‚"
            }
        ],
        "temperature": 0.7,
        "max_tokens": 2000
    }

    try:
        print("=" * 80)
        print("æ–¹æ³• 1: OpenAI æ ¼å¼ + æ¥æºæ ‡æ³¨æç¤ºè¯")
        print("=" * 80)

        response = requests.post(url, headers=headers, json=data, timeout=30)
        print(f"çŠ¶æ€ç : {response.status_code}")

        if response.status_code == 200:
            result = response.json()

            if "choices" in result and len(result["choices"]) > 0:
                content = result["choices"][0]["message"]["content"]

                print(f"\nğŸ“° å›½é™…æ–°é—»ï¼ˆå¸¦æ¥æºæ ‡æ³¨ï¼‰\n")
                print(content)
                print("\n" + "=" * 80)

                # ä¿å­˜
                timestamp = datetime.now().strftime('%Y%m%d_%H%M%S')
                filename = f"news_openai_sources_{timestamp}.txt"

                with open(filename, "w", encoding="utf-8") as f:
                    f.write(f"å›½é™…æ–°é—» (OpenAI æ ¼å¼ + æ¥æºæ ‡æ³¨) - {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\n")
                    f.write("=" * 80 + "\n\n")
                    f.write(content)
                    f.write("\n\n" + "=" * 80 + "\n")
                    f.write("æ³¨æ„ï¼šä»¥ä¸Šæ–°é—»åŸºäº AI çš„çŸ¥è¯†åº“ï¼ˆæˆªæ­¢2024å¹´4æœˆï¼‰ï¼Œä¸æ˜¯å®æ—¶ç½‘ç»œæœç´¢ç»“æœã€‚\n")
                    f.write("å¦‚éœ€å®æ—¶æ–°é—»ï¼Œè¯·ä½¿ç”¨ï¼špython get_news_with_websearch_final.py\n")

                print(f"\nâœ“ å·²ä¿å­˜åˆ° {filename}")

                # ä¹Ÿä¿å­˜ JSON
                json_file = f"news_openai_sources_{timestamp}.json"
                with open(json_file, "w", encoding="utf-8") as f:
                    json.dump(result, f, indent=2, ensure_ascii=False)
                print(f"âœ“ JSON å“åº”å·²ä¿å­˜åˆ° {json_file}")

                return True

        else:
            print(f"âŒ è¯·æ±‚å¤±è´¥: {response.status_code}")
            print(f"é”™è¯¯: {response.text}")
            return False

    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        return False

def get_news_comparison():
    """
    å¯¹æ¯”è¯´æ˜ï¼šOpenAI æ ¼å¼ vs Anthropic Messages æ ¼å¼
    """

    print("\n" + "=" * 80)
    print("ğŸ“Š ä¸¤ç§æ ¼å¼å¯¹æ¯”")
    print("=" * 80)

    comparison = """
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç‰¹æ€§                    â”‚ OpenAI æ ¼å¼          â”‚ Anthropic Messages   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ç«¯ç‚¹                    â”‚ /v1/chat/completions â”‚ /v1/messages         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å®æ—¶ç½‘ç»œæœç´¢            â”‚ âŒ ä¸æ”¯æŒ            â”‚ âœ… æ”¯æŒ web_search   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Function Calling        â”‚ âœ… æ”¯æŒï¼ˆæ‰‹åŠ¨ï¼‰      â”‚ âœ… æ”¯æŒï¼ˆè‡ªåŠ¨ï¼‰      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ•°æ®æ¥æº                â”‚ AI çŸ¥è¯†åº“            â”‚ å®æ—¶ç½‘ç»œæœç´¢         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å“åº”é€Ÿåº¦                â”‚ âš¡ å¿«ï¼ˆ10-20ç§’ï¼‰     â”‚ ğŸŒ æ…¢ï¼ˆ60-90ç§’ï¼‰     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ çŸ¥è¯†æ—¶æ•ˆæ€§              â”‚ æˆªæ­¢2024å¹´4æœˆ        â”‚ å®æ—¶                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¥æºé“¾æ¥                â”‚ âŒ æ— çœŸå®é“¾æ¥        â”‚ âœ… æä¾›çœŸå®URL       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ¨èåœºæ™¯                â”‚ å†å²äº‹ä»¶ã€å¿«é€ŸæŸ¥è¯¢   â”‚ æœ€æ–°æ–°é—»ã€éœ€è¦æ¥æº   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä½¿ç”¨å»ºè®®ï¼š

1. éœ€è¦æœ€æ–°æ–°é—» + çœŸå®æ¥æºï¼š
   â†’ ä½¿ç”¨ get_news_with_websearch_final.py (Anthropic Messages + web_search)

2. å¿«é€Ÿè·å–æ–°é—»æ¦‚è§ˆï¼ˆä¸éœ€è¦å®æ—¶æ€§ï¼‰ï¼š
   â†’ ä½¿ç”¨ get_news.py (OpenAI æ ¼å¼)
   â†’ ä½¿ç”¨æœ¬è„šæœ¬ (OpenAI æ ¼å¼ + æ¥æºæ ‡æ³¨)

3. å†å²äº‹ä»¶åˆ†æï¼š
   â†’ ä½¿ç”¨ get_news.py æˆ– get_news_final.py
"""

    print(comparison)

    print("\næ¨èçš„å·¥ä½œæµç¨‹ï¼š")
    print("  1. å…ˆç”¨ OpenAI æ ¼å¼å¿«é€Ÿäº†è§£æ–°é—»æ¦‚å†µï¼ˆæœ¬è„šæœ¬ï¼‰")
    print("  2. å¦‚éœ€éªŒè¯æˆ–è·å–è¯¦ç»†æ¥æºï¼Œä½¿ç”¨ web_search ç‰ˆæœ¬")
    print("  3. å¯¹æ¯”ä¸¤è€…ç»“æœï¼Œè·å¾—æ›´å…¨é¢çš„ä¿¡æ¯")

if __name__ == "__main__":
    print("=" * 80)
    print("å›½é™…æ–°é—»è·å–å·¥å…· - OpenAI æ ¼å¼ï¼ˆå¸¦æ¥æºæ ‡æ³¨ï¼‰")
    print(f"æ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    print("=" * 80)

    print("\næ³¨æ„ï¼š")
    print("  - OpenAI æ ¼å¼ä¸æ”¯æŒè‡ªåŠ¨ç½‘ç»œæœç´¢")
    print("  - æ–°é—»åŸºäº AI çŸ¥è¯†åº“ï¼ˆæˆªæ­¢2024å¹´4æœˆï¼‰")
    print("  - æ¥æºä¿¡æ¯ç”± AI æ ‡æ³¨ï¼Œä¸æ˜¯å®æ—¶æœç´¢ç»“æœ")
    print("  - å¦‚éœ€å®æ—¶æ–°é—»å’ŒçœŸå®æ¥æºï¼Œè¯·ä½¿ç”¨ï¼š")
    print("    python get_news_with_websearch_final.py")

    print("\n" + "=" * 80)

    # æ‰§è¡Œ
    success = get_news_openai_format_with_source_prompt()

    if success:
        # æ˜¾ç¤ºå¯¹æ¯”ä¿¡æ¯
        get_news_comparison()

    print("\n" + "=" * 80)
    print("å®Œæˆ")
    print("=" * 80)
